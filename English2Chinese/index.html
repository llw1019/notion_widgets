<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocabulary Flashcards</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: white;
            overflow: hidden;
            transition: background-color 0.3s;
        }
        .vocab-container {
            text-align: center;
            background-color: #f0f0f0;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            transition: background-color 0.3s, color 0.3s;
        }
        .vocab-container h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        .vocab-container p {
            font-size: 18px;
            margin: 5px 0;
            text-align: left;
        }
        #api-key-form {
            display: none;
            text-align: center;
            margin-top: 20px;
        }
        #api-key-input {
            font-size: 16px;
            padding: 8px;
            width: 80%;
            margin-bottom: 10px;
        }
        #api-key-button {
            font-size: 16px;
            padding: 8px 16px;
        }
        #api-key-error {
            text-align: center;
            color: red;
            display: none;
        }

        @media (prefers-color-scheme: dark) {
            body {
                background-color: rgb(25, 25, 25);
            }
            .vocab-container {
                background-color: #333;
                color: white;
            }
        }
    </style>
</head>
<body>
    <div class="vocab-container">
        <h1 id="english-word">Loading...</h1>
        <p id="chinese-translation"></p>
        <p id="part-of-speech"></p>
        <p id="phonetics"></p>
        <p id="definition"></p>
        <p id="example-sentence"></p>
        <div id="api-key-form">
            <input type="text" id="api-key-input" placeholder="請輸入您的 API Key">
            <button id="api-key-button">保存 API Key</button>
            <p id="api-key-error">無效的 API Key</p>
        </div>
    </div>

    <!-- 引用外部的 vocab.js 文件 -->
    <!--<script src="vocab.js"></script>-->
    <script src="words.js"></script>
    <script>
        async function updateVocabulary() {
            /* 從本地單詞數組中獲取隨機單詞和翻譯及詳細信息 */
            try {
                const englishWordElement = document.getElementById('english-word');
                const chineseTranslationElement = document.getElementById('chinese-translation');
                const partOfSpeechElement = document.getElementById('part-of-speech');
                const phoneticsElement = document.getElementById('phonetics');
                const definitionElement = document.getElementById('definition');
                const exampleSentenceElement = document.getElementById('example-sentence');

                /* 清除所有內容 */
                englishWordElement.textContent = '';
                chineseTranslationElement.textContent = '';
                partOfSpeechElement.textContent = '';
                phoneticsElement.textContent = '';
                definitionElement.textContent = '';
                exampleSentenceElement.textContent = '';

                /* 更新單詞和相關信息 */
                /* USE API BEGIN */
                //const randomWord = await fetchRandomWord(); /* API. */
                const randomWord = words[Math.floor(Math.random() * words.length)]; /* Local (words.js). */
                englishWordElement.textContent = randomWord;

                const chineseTranslation = await fetchTranslation(randomWord);
                chineseTranslationElement.textContent = `翻譯: ${chineseTranslation}`;

                const details = await fetchWordDetails(randomWord);

                if (details) {
                    partOfSpeechElement.textContent = `詞性: ${details.partOfSpeech}`;
                    phoneticsElement.textContent = `音標: ${details.phonetics}`;
                    //definitionElement.textContent = `定義: ${details.definition}`;
                    exampleSentenceElement.textContent = `例句: ${details.exampleSentence}`;
                } else {
                    partOfSpeechElement.textContent = '';
                    phoneticsElement.textContent = '';
                    definitionElement.textContent = '';
                    exampleSentenceElement.textContent = '';
                }
                /* USE API END */

                /* USE vocab.js BEGIN */
                /* 如果 vocabList 已經被加載，從中選擇一個單詞顯示 */
                // if (typeof vocabList !== 'undefined') {
                //     const randomVocab = vocabList[Math.floor(Math.random() * vocabList.length)];
                //     englishWordElement.textContent = randomVocab.english;
                //     chineseTranslationElement.textContent = `翻譯: ${randomVocab.chinese}`;
                //     partOfSpeechElement.textContent = `詞性: ${randomVocab.partOfSpeech}`;
                //     phoneticsElement.textContent = `音標: ${randomVocab.phonetics}`;
                //     exampleSentenceElement.textContent = `例句: ${randomVocab.example}`;
                /* USE vocab.js END */
            } catch (error) {
                console.error('Error loading vocabulary:', error);
                document.getElementById('english-word').textContent = 'Error loading vocabulary';
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            /* 設置主題 */
            const theme = localStorage.getItem('mode');
            if (theme) {
                document.body.style.backgroundColor = theme === 'dark' ? 'rgb(25, 25, 25)' : 'white';
                const vocabContainer = document.querySelector('.vocab-container');
                if (theme === 'dark') {
                    vocabContainer.style.backgroundColor = '#333';
                    vocabContainer.style.color = 'white';
                } else {
                    vocabContainer.style.backgroundColor = '#f0f0f0';
                    vocabContainer.style.color = 'black';
                }
            }

            await checkAndSetApiKey();

            /* 初始化單詞和相關信息 */
            updateVocabulary();

            /* 監聽點擊事件 */
            document.querySelector('.vocab-container').addEventListener('click', async () => {
                if (document.getElementById('api-key-form').style.display !== 'block') {
                    /* 檢查是否有選取的文字 */
                    const selection = window.getSelection().toString();
                    if (!selection) {
                        /* 如果沒有選取的文字，觸發更新操作 */
                        updateVocabulary();
                    }
                }
            });

            /* 監聽觸摸事件 */
            var startY = 0; /* 起始Y坐標 */
            var dist = 0; /* 移動距離 */

            document.addEventListener('touchstart', handleTouchStart, false);
            document.addEventListener('touchmove', handleTouchMove, false);

            function handleTouchStart(event) {
                startY = event.touches[0].clientY;
                dist = 0;
            }

            function handleTouchMove(event) {
                var currentY = event.touches[0].clientY;
                dist = currentY - startY;
            }

            document.addEventListener('touchend', function () {
                if (document.getElementById('api-key-form').style.display !== 'block') {
                    if (dist > 50) { /* 如果移動距離大於50px，認為是下拉操作 */
                        /* 觸發更新操作 */
                        updateVocabulary();
                    }
                }
            }, false);

            /* 監聽 API Key 保存按鈕點擊事件 */
            document.getElementById('api-key-button').addEventListener('click', handleApiKeySave);
        });

        async function checkAndSetApiKey() {
            let apiKey = localStorage.getItem('Groq_apiKey');
            if (!apiKey) {
                showApiKeyForm();
            } else {
                document.getElementById('api-key-form').style.display = 'none';
            }
        }

        function showApiKeyForm() {
            const apiKeyForm = document.getElementById('api-key-form');
            const apiKeyInput = document.getElementById('api-key-input');
            const apiKeyButton = document.getElementById('api-key-button');
            const apiKeyError = document.getElementById('api-key-error');

            apiKeyInput.disabled = false;
            apiKeyButton.disabled = false;
            apiKeyForm.style.display = 'block';
            apiKeyError.style.display = 'none';
        }

        async function handleApiKeySave() {
            const apiKeyForm = document.getElementById('api-key-form');
            const apiKeyInput = document.getElementById('api-key-input');
            const apiKeyButton = document.getElementById('api-key-button');
            const apiKeyError = document.getElementById('api-key-error');
            const apiKey = apiKeyInput.value;

            if (apiKey) {
                apiKeyInput.disabled = true;
                apiKeyButton.disabled = true;
                apiKeyError.style.display = 'none';

                const isValid = await validateApiKey(apiKey);
                if (isValid) {
                    localStorage.setItem('Groq_apiKey', apiKey);
                    apiKeyForm.style.display = 'none';
                    updateVocabulary();
                } else {
                    apiKeyInput.disabled = false;
                    apiKeyButton.disabled = false;
                    apiKeyError.style.display = 'block';
                }
            } else {
                apiKeyError.style.display = 'block';
            }
        }

        async function validateApiKey(apiKey) {
            try {
                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        "messages": [
                            {
                                "role": "user",
                                "content": "Reply an 'ok'"
                            },
                            {
                                "role": "assistant",
                                "content": "ok"
                            }
                        ],
                        "model": "llama3-8b-8192",
                        "temperature": 0,
                        "max_tokens": 1,
                        "top_p": 1,
                        "stream": false
                    })
                });

                if (response.ok) {
                    return true;
                } else {
                    const errorData = await response.json();
                    if (errorData.error && errorData.error.code === 'invalid_api_key') {
                        return false;
                    }
                    throw new Error(errorData.error.message);
                }
            } catch (error) {
                console.error('API Key validation error:', error);
                return false;
            }
        }

        async function fetchRandomWord() {
            const response = await fetch('https://random-word-api.herokuapp.com/word?number=1');
            const words = await response.json();
            return words[0];
        }

        async function fetchTranslation(word) {
            const response = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=zh-TW&dt=t&q=${encodeURIComponent(word)}`);
            const translation = await response.json();
            return translation[0][0][0];
        }

        async function fetchWordDetails(word) {
            try {
                const apiKey = localStorage.getItem('Groq_apiKey');
                const prompt = `Please provide the following details for the English word "${word}": 
                                1. Part of speech
                                2. KK phonetics
                                3. Definition
                                4. An example sentence
                                and return the details in the following JSON format:
                                {
                                    "part_of_speech": "<part_of_speech>",
                                    "phonetics": "<phonetics>",
                                    "definition": "<definition>",
                                    "example_sentence": "<example_sentence>"
                                }`;

                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        "messages": [
                            {
                                "role": "user",
                                "content": prompt
                            }
                        ],
                        "model": "llama3-8b-8192",
                        "temperature": 0,
                        "max_tokens": 255,
                        "top_p": 1,
                        "stream": false,
                        "response_format": {
                            "type": "json_object"
                        },
                        "stop": null
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    if (errorData.error && errorData.error.code === 'invalid_api_key') {
                        localStorage.removeItem('Groq_apiKey');
                        showApiKeyForm();
                        return null;
                    }
                    throw new Error(errorData.error.message);
                }

                const data = await response.json();
                const content = data.choices[0].message.content;

                const details = JSON.parse(content);

                const partOfSpeech = details.part_of_speech || 'N/A';
                const phonetics = details.phonetics || 'N/A';
                const definition = details.definition || 'No definition available';
                const exampleSentence = details.example_sentence || 'No example available';

                return { partOfSpeech, phonetics, definition, exampleSentence };
            } catch (error) {
                console.error('Error fetching word details:', error);
                return null;
            }
        }
    </script>
</body>
</html>
